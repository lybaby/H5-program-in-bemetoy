/*! 09-05-2016 */
define("helper/playerbar",["comm/utils","comm/zeptodata","comm/clickevent","helper/app","helper/temphtml","helper/jrange","jplayer","page/myalbum","page/myhistory","page/myplay","require","exports"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m="#J_jplayer-box",n=null,o=null,p=!1,q=!1,r="#J_jplayer-box_1",s="#J_jplayer-weixin",t=!0,u=!1,v={},w=0,x=null,y=!1,z=null,A=function(a){var b="active-play-item",d=a.attr("url");a.parent().find(".item").removeClass(b),a.addClass(b),o.length>0&&a.attr("sid")==o.attr("sid")&&("none"!=o.css("display")&&(o.remove(),n.addClass("item-option-showplay"),n.show()),o.remove()),n.find(".op-del").hide(),"true"==a.attr("user")&&n.find(".op-del").show(),n.attr("sid",a.attr("sid")),n.insertAfter(a),p._totalTime.text(a.find(".desc").text()),$(".load-bar").css("width","0"),p.jPlayer("setMedia",{mp3:d}),p.jPlayer("play"),y=!1;try{var e="试听"+document.title,f="试听"+$(a).find(".title").text(),g="试听"+c.findName();_czc.push(["_trackEvent",e,g,f])}catch(h){}},B=function(a){var b="active-play-item",c=a.attr("url");a.parent().find(".item").removeClass(b),a.addClass(b);var d=$(s);d.attr("sid",a.attr("sid")),d.insertAfter(a),p._totalTime.text(a.find(".desc").text()),$(".load-bar").css("width","0"),p.jPlayer("setMedia",{mp3:c}),p.jPlayer("play")},C=function(b){p.jPlayer({ready:function(a){p.jPlayer("setMedia",{mp3:b}),a.jPlayer.html.used&&a.jPlayer.html.audio.available&&(this._audio=$(this).data("jPlayer").htmlElement.audio)},progress:function(a){var b=a.jPlayer.status.remaining||0,c=(a.jPlayer.status.readyState,0),d=this;if("object"==typeof d._audio.buffered&&d._audio.buffered.length>0){if(d._audio.duration>0){for(var e=0,f=0;f<d._audio.buffered.length;f++)e+=d._audio.buffered.end(f)-d._audio.buffered.start(f);c=100*e/d._audio.duration}}else c=0;var g=100*(d._audio.duration-b)/d._audio.duration;c=g+c>=100?100:g+c,$(".load-bar").css("width",c+"%"),console.log(c)},timeupdate:function(b){var c=b.jPlayer.status,d=c.currentPercentAbsolute;if(!c.waitForLoad&&!y)try{var e={};e.name=$(this).parent().attr("name"),y=!0,window.bemetoy.playMusicWithInfo(JSON.stringify(e))}catch(f){}p.playedTime.text(a.formatTime(c.currentTime||0));var g=p._slider.data("plugin_jRange");g&&(g.setValue(d),100==d&&(g.setValue(0),p.playedTime.text("00:00")))},play:function(a){n.find(".btn-single").length<1?n.find(".btn-play").addClass("btn-pause"):n.find(".op-play").addClass("op-pause"),u=!0},pause:function(a){n.find(".btn-single").length<1?n.find(".btn-play").removeClass("btn-pause"):n.find(".op-play").removeClass("op-pause")},ended:function(a){if(n.find(".btn-single").length<1?n.find(".btn-play").removeClass("btn-pause"):n.find(".op-play").removeClass("op-pause"),$(".song-page").length>0){var b=$(".song-page .play-cover");b.addClass("pause"),b.attr("src","./static/images/bofang.png")}var c="active-play-item",d=$("."+c),e=d.parent().find(".item"),f=++w%e.length,g=e.eq(f);$(s).length>0?B(g):A(g)},smoothPlayBar:!0,supplied:"mp3",preload:"none",wmode:"window"}),p._slider&&p._slider.data("plugin_jRange").setValue(0)},D=function(){p=n.find(".player"),p.playedTime=n.find(".played-time"),p._totalTime=n.find(".total-time"),p._slider=n.find(".slider"),p.jPlayer("clearMedia"),p._slider.jRange({from:0,to:100,step:1,width:"68%",format:"%s",ondragchange:function(a){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(function(){p.jPlayer("playHead",a)},100)}}),n.on("click",".btn-play1",function(){var a=$(this);return a.hasClass("btn-pause")?p.jPlayer("pause"):p.jPlayer("play"),!1}).on("click",".op-push",function(){var a=$(m).index()-1;c.pushSongLi($(m).parent().find("li")[a])}).on("click",".op-play",function(){var a="item-option-showplay";if(w=$("#J_jplayer-box").index()-1,$(r).length>0&&$(r).index()<w&&(w-=1),n.hasClass(a))$(this).hasClass("op-pause")?p.jPlayer("pause"):p.jPlayer("play");else{n.addClass(a);var b=$("#J_jplayer-box").parent().find(".item");A(b.eq(w%b.length))}}).on("click",".op-up",function(){d.showTips("产品原因，点不动")}).on("click",".op-add",function(){h.showAddMyablumBox(v.id,v.tag,v.tagval)}).on("click",".op-del",function(){"history"===v._type&&i.deleteHistory(v.relate_id),"play"===v._type&&j.deletePlay(v.relate_id)}).on("click",".op-share",function(){c.shareToWeixin(v.id,"song",v.tag,v.tagval)})},E=function(a){q=o.find(".player"),o.on("click",".btn-play",function(){var a=$(this);return a.hasClass("btn-pause")?q.jPlayer("pause"):q.jPlayer("play"),!1}).on("click",".op-push",function(){var a=$(r).index()-1;c.pushSongLi($(r).parent().find("li")[a])}).on("click",".op-play",function(){w=o.index()-2,o.index()<n.index()&&(w=o.index()-1),o.remove(),A(a),n.show()}).on("click",".op-up",function(){d.showTips("产品原因，点不动")}).on("click",".op-add",function(){h.showAddMyablumBox(v.id,v.tag,v.tagval)}).on("click",".op-del",function(){"history"===v._type&&i.deleteHistory(v.relate_id),"play"===v._type&&j.deletePlay(v.relate_id)})},F=function(a){p=n.find(".player"),p.playedTime=n.find(".played-time"),p._totalTime=n.find(".total-time"),p._slider=n.find(".slider"),p.jPlayer("clearMedia"),p._slider.jRange({from:0,to:100,step:1,width:"68%",format:"%s",ondragchange:function(a){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(function(){p.jPlayer("playHead",a)},100)}}),n.on("click",".btn-play",function(a){a.stopPropagation();var b=$(this);return b.hasClass("btn-pause")?p.jPlayer("pause"):p.jPlayer("play"),!1}).on("click",".btn-song",function(){if($(".song-page").length>0){var a=$(".song-page .play-cover");return void(a.hasClass("pause")?(a.removeClass("pause"),p.jPlayer("play"),a.attr("src","./static/images/zanting.png")):(a.addClass("pause"),p.jPlayer("pause"),a.attr("src","./static/images/bofang.png")))}}).on("click",".play",function(){var a=$(this);return a.hasClass("pause")?(p.jPlayer("pause"),a.removeClass("pause")):(p.jPlayer("play"),a.addClass("pause")),!1})};l.initPlayer=function(b,c,f){z=x=b,v=c,n=$(m),o=$(r);var g=n.attr("sid");if(g==c.id)return"none"!=n.css("display")?n.hide():(o.hide(),n.show());var h=o.attr("sid");if(h==c.id)return"none"!=o.css("display")?o.hide():(n.hide(),o.show());n.length<1?(n=$(e.playOptionHtml),n.insertAfter(b),D(),n.find(".btn-play").removeClass("btn-pause"),n.removeClass("item-option-showplay"),p._totalTime.text(a.formatTime(v.song_time||v.radio_time)),n.find(".op-del").hide(),c.user&&n.find(".op-del").show(),n.find(".op-up").hide(),n.attr("sid",c.id).show(),n.attr("name",c.name),C(v.url),t=!1,p.jPlayer("setMedia",{mp3:v.url})):u?(o.remove(),n.hide(),o.length<1&&(o=$(e.playOptionHtmlOther)),o.insertAfter(b),E(b),o.removeClass("item-option-showplay"),o.find(".op-del").hide(),c.user&&o.find(".op-del").show(),o.find(".op-up").hide(),o.attr("sid",c.id).show(),o.attr("name",c.name)):(n.insertAfter(b),n.find(".btn-play").removeClass("btn-pause"),n.removeClass("item-option-showplay"),p._totalTime.text(a.formatTime(v.song_time||v.radio_time)),n.find(".op-del").hide(),c.user&&n.find(".op-del").show(),n.find(".op-up").hide(),n.attr("sid",c.id).show(),n.attr("name",c.name),C(v.url),t=!1,p.jPlayer("setMedia",{mp3:v.url}));var i=d.getUA(1);i>0&&$(".item-option-box .op-share").show()},l.initWeixinPlayer=function(b,c,d){n=$(s);var f="active-play-item",g=n.attr("sid");return g==c.id?"none"!=n.css("display")?n.hide():n.show():(n.length<1?(w=b.index(),n=$(e.playWeixinHtml),n.insertAfter(b),F(),n.find(".player-slider").show(),n.addClass("item-option-showplay"),p._totalTime.text(a.formatTime(c.song_time||c.radio_time)),n.attr("sid",c.id).show(),C(c.url),t=!1,p.jPlayer("setMedia",{mp3:c.url}),b.addClass(f),setTimeout(function(){p.jPlayer("play")},100)):(w=b.index(),n.index()<w&&(w-=1),n.insertAfter(b),n.find(".btn-play").removeClass("btn-pause"),n.addClass("item-option-showplay"),p._totalTime.text(a.formatTime(c.song_time||c.radio_time)),n.attr("sid",c.id).show(),C(c.url),t=!1,p.jPlayer("setMedia",{mp3:c.url}),b.parent().find(".item").removeClass(f),b.addClass(f),p.jPlayer("play")),void n.find(".btn-single").removeClass("btn-single"))},l.initIpPlay=function(b,c){n=$(e.playWeixinHtml),n.insertAfter(b),F(),n.find(".player-slider").show(),n.addClass("item-option-showplay"),p._totalTime.text(a.formatTime(c.song_time||c.radio_time)),n.attr("sid",c.id).show(),n.attr("name",c.name),C(c.url),n.find(".btn-single").removeClass("btn-single"),t=!1,p.jPlayer("setMedia",{mp3:c.url})},l.initIpIndexPlay=function(b,c,d){1==d&&(n=$(e.playWeixinHtml)),2==d&&(n=$(e.playBearSongHtml)),3==d&&(n=$(e.playMikaSongHtml)),4==d&&(n=$(e.playBearHtml)),5==d&&(n=$(e.playMikaHtml)),n.insertAfter(b),F(),n.find(".player-slider").show(),n.addClass("item-option-showplay"),p._totalTime.text(a.formatTime(c.song_time||c.radio_time)),n.attr("sid",c.id).show(),n.attr("name",c.name),C(c.url),(2==d||3==d)&&n.find(".btn-single").removeClass("btn-single"),t=!1,p.jPlayer("setMedia",{mp3:c.url})},l.initWeixinSongPlay=function(b,c){n=$(e.playWeixinSongHtml),n.insertAfter(b),F(),n.find(".player-slider").show(),n.addClass("item-option-showplay"),p._totalTime.text(a.formatTime(c.song_time||c.radio_time)),n.attr("sid",c.id).show(),C(c.url),n.find(".slider-container").find(".high").removeClass("btn-play"),n.find(".slider-container").find(".high").addClass("btn-song"),t=!1,p.jPlayer("setMedia",{mp3:c.url})},l.stopPlayer=function(){p&&p.jPlayer("stop"),t=!0},l.uninit=function(){w=0,n.off("click"),l.stopPlayer()}});