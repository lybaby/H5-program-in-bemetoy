/*! 09-05-2016 */
define("page/myhistory",["comm/utils","comm/url","comm/request","comm/clickevent","page/myalbum","helper/app","helper/playerbar","require","exports"],function(a,b,c,d,e,f,g,h,i){"use strict";var j={},k=!1,l=function(b){if(0===b.count)return $("#have-history").hide(),$(".song-fail").show(),void f.noScroll();if(!(b.playing_count||b.unplaying_count||b.history_count||b.have_count))return $("#have-history").hide(),void $(".song-fail").show();if(b.playing_count){var c=a.template("J_temp-nitem",{list:b.playing_count});$("#J_play_list").html(c)}else{var c='<div class="no-content">玩具没有正在收听节目</div>';$("#J_play_list").html(c)}if(b.unplaying_count){var c=a.template("J_temp-nitem",{list:b.unplaying_count});$("#J_noplay_list").html(c)}else{var c='<div class="no-content">玩具尚无待接收歌曲</div>';$("#J_noplay_list").html(c)}if(b.history_count){var c=a.template("J_temp-nitem",{list:b.history_count});$("#J_played_list").html(c)}else{var c='<div class="no-content">玩具尚无已播放歌曲</div>';$("#J_played_list").html(c)}if(b.have_count){var c=a.template("J_temp-nitem",{list:b.have_count});$("#J_waiting_list").html(c)}else{var c='<div class="no-content">玩具尚无待播放歌曲</div>';$("#J_waiting_list").html(c)}$.each(b.history_count,function(a,b){b._type="history",j[b.relate_id]=b}),$.each(b.playing_count,function(a,b){b._type="history",j[b.relate_id]=b}),$.each(b.unplaying_count,function(a,b){b._type="no_have",j[b.relate_id]=b}),$.each(b.have_count,function(a,b){b._type="history",j[b.relate_id]=b}),f.backScroll()},m=function(b){c.getLocalRequest({url:BEME.APIURL+"/listen/getHistory",type:"post",data:{uid:a.getUid()},successfn:function(a){return f.loaded(),0!==a.code?($("#have-history").hide(),$(".song-fail").show(),void f.noScroll()):void l(a.data)}})};i.deleteHistory=function(b){c.getRequest({url:BEME.APIURL+"/listen/deleteHistory",data:{id:b,uid:a.getUid()},type:"POST",successfn:function(a){f.showTips("删除歌曲成功"),0===a.code&&(m(),$(".select-all").hide(),$("#J_wrapper .item").find(".checkbox").hide(),$(".title").show())}})},i.deleteNoHistory=function(b){c.getRequest({url:BEME.APIURL+"/listen/deleteNoSendSong",data:{ids:b,uid:a.getUid()},type:"POST",successfn:function(a){f.showTips("删除歌曲成功"),0===a.code&&(m(),$(".select-all").hide(),$("#J_wrapper .item").find(".checkbox").hide(),$(".title").show())}})};var n=function(a){$(".select-all").remove();var b='<div class="select-all"  _type="'+a+'"><a class="left" href="javascript:void(0);" value="0"><img src="./static/images/xuanzekong.png"></a><a class="title">全选</a><a class="right content" href="javascript:void(0);" id="cancel">取消</a><a class="right content_add"  href="javascript:void(0);" id="delete">删除</a></div>';1==a?$(b).insertAfter($("#delete-noplay")):$(b).insertAfter($("#delete-played")),q()},o=function(a){var b=a.find(".checkbox").attr("value"),c=a.parent().parent().find(".item").find(".checkbox");if(0==+b){$(a.find(".checkbox")).find("img").attr("src","./static/images/xuanze.png"),a.find(".checkbox").attr("value","1");var d=0,e=!1;$.each(c,function(a,b){0==$(b).attr("value")&&d++,1==$(b).attr("value")&&(e=!0)}),d||($(".delete-all .left").length?($(".delete-all .left img").attr("src","./static/images/xuanze.png"),$(".delete-all .left").attr("value",1),$(".select-all .left img").attr("src","./static/images/xuanze.png"),$(".select-all .left").attr("value",1)):($(".select-all .left img").attr("src","./static/images/xuanze.png"),$(".select-all .left").attr("value",1))),e?($("#add").removeClass("content_add"),$("#add").addClass("content"),$("#delete").removeClass("content_add"),$("#delete").addClass("content")):($("#add").removeClass("content"),$("#add").addClass("content_add"),$("#delete").removeClass("content"),$("#delete").addClass("content_add"))}else{$(a.find(".checkbox")).find("img").attr("src","./static/images/xuanzekong.png"),a.find(".checkbox").attr("value","0");var e=!1;if($.each(c,function(a,b){1==$(b).attr("value")&&(e=!0)}),e?($("#add").removeClass("content_add"),$("#add").addClass("content"),$("#delete").removeClass("content_add"),$("#delete").addClass("content")):($("#add").removeClass("content"),$("#add").addClass("content_add"),$("#delete").removeClass("content"),$("#delete").addClass("content_add")),$(".delete-all .left").length){var f=$(".delete-all .left").attr("value");1==+f&&($(".delete-all .left img").attr("src","./static/images/xuanzekong.png"),$(".delete-all .left").attr("value",0),$(".select-all .left img").attr("src","./static/images/xuanzekong.png"),$(".select-all .left").attr("value",0))}else{var f=$(".select-all .left").attr("value");1==+f&&($(".select-all .left img").attr("src","./static/images/xuanzekong.png"),$(".select-all .left").attr("value",0))}}},p=function(a){$("#have-history").on("click",".item .item-c",function(){var b=$(this);k?o($(this)):(d.pushSong(b),setTimeout(function(){m(a)},1e3))}),$("#have-history").on("click",".item-play",function(a){if(!k){var b=$(this).parent(),c=b.attr("rid");g.initPlayer(b,j[+c])}}),$(".header").on("click","a",function(){var a=$(this);$(".header").find(".cur").removeClass("cur"),$(this).parent().addClass("cur");var b=a.attr("_type");1==b&&($(".no_song").show(),$(".have_song").hide(),$(".have_played").hide()),2==b&&($(".no_song").hide(),$(".have_song").show(),$(".have_played").hide(),m()),3==b&&($(".no_song").hide(),$(".have_song").hide(),$(".have_played").show())}),$(".no_song .delete-btn").on("click",function(){var a={};a.content="删除全部曲目？删除后玩具将不会收到这些歌曲";var b=[],c=$("#J_noplay_list").find(".item");0!=c.length&&($.each(c,function(a,c){b.push($(c).attr("rid"))}),0!=b.length&&f.showAlert(a,function(){i.deleteNoHistory(b.join(","))}))}),$(".have_played .delete-btn").on("click",function(){n(2);$(this);$(this).hide(),$(".select-all").show(),$(".have_played .item").find(".checkbox").show(),k=!0})},q=function(){$(".select-all").off("click"),$(".select-all").on("click",".left",function(){var a=$(this).parent(),b=a.find(".left").attr("value"),c=a.parent().parent().find(".item").find(".checkbox");0==+b?(a.find("img").attr("src","./static/images/xuanze.png"),a.find(".left").attr("value",1),$.each(c,function(a,b){$(b).find("img").attr("src","./static/images/xuanze.png"),$(b).attr("value",1)}),$("#delete").removeClass("content_add"),$("#delete").addClass("content")):(a.find("img").attr("src","./static/images/xuanzekong.png"),a.find(".left").attr("value",0),$.each(c,function(a,b){$(b).find("img").attr("src","./static/images/xuanzekong.png"),$(b).attr("value",0)}),$("#delete").removeClass("content"),$("#delete").addClass("content_add"))}),$(".select-all").on("click","#cancel",function(){$(".select-all").hide(),$("#J_wrapper .item").find(".checkbox").hide(),$.each($("#J_wrapper .item").find(".checkbox"),function(a,b){$(b).find("img").attr("src","./static/images/xuanzekong.png"),$(b).attr("value",0)}),$(".title").show(),k=!1}),$(".select-all").on("click","#delete",function(){var a=$(this).parent().parent().find(".item"),b=$(this).parent().attr("_type"),c=[];if($.each(a,function(a,b){var d=$(b),e=d.find(".checkbox").attr("value");1===+e&&c.push(d.attr("rid"))}),0===c.length);else{var d={};d.content="确定删除所选歌曲？",f.showAlert(d,function(){1==b?i.deleteNoHistory(c.join(",")):i.deleteHistory(c.join(",")),k=!1})}})};i.init=function(){f.setTitle("点播足迹");var c=b.getParams();$(".back-btn").show(),a.headerMenu(),$("#myplay").show(),f.showHeader(),m(c.id),p(c.id)},i.uninit=function(){}});