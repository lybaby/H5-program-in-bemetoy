/*! 09-05-2016 */
define("minpage/book",["comm/utils","comm/pushsong","comm/url","comm/request","jplayer","helper/app","require","exports"],function(a,b,c,d,e,f,g,h){"use strict";var i=[],j=[],k=[],l=!1,m=!1,n=0,o=0,p=0,q=!0,r=0,s=0,t=$("#player"),u={title:"贝美时光说-成长场景",desc:"小囧熊英文乐园",link:location.href,imgUrl:"专辑图片放进来"},v=function(b,c){s=$(window).height(),r=$(window).width()-50,$(document.body).css("height",s),$(document.body).css("overflow","hidden"),$.each(b.song,function(a,b){j.push(b.img_url),b.url?k.push(b.url):k.push(1),i.push(b)}),$(".footer_blank").hide(),u.title=b.name,u.desc=b.description,u.imgUrl=b.url,f.showShare(),p=b.screenModel,o=b.song.length,1==p?($(".show-warning").show(),$(".img-block").addClass("h-block"),$(document.body).css("height",s),$("#J_slidebox").removeClass("hslide-box"),$("#J_btnsbox").removeClass("btns-box-in btns-box-out").css("zoom"),$("#J_btnsbox").addClass("btns-box-in"),$("#J_btnsbox").addClass("btns-h"),90==window.orientation&&($(".show-warning").hide(),$(".img-block").removeClass("h-block"),$(document.body).css("height",s),$("#J_slidebox").addClass("hslide-box"),$("#J_btnsbox").removeClass("btns-h"),$("#book-img").addClass("imgClass"),w(4e3))):($(".show-warning").hide(),$(".img-block").removeClass("h-block"),$("#J_slidebox").removeClass("hslide-box"),$("#J_btnsbox").addClass("btns-h"));var d=[];d.push(j.slice(0,2)),d.push(j.slice(2,j.length)),a.loadImages(d[0],function(a,b){if(!a){var c=100/d[0].length,e=Math.floor(b*c+Math.random()*c);return e>100&&(e=100),$("#J_loadingbox .text span").text(e+"%")}l=!0,z()}),a.loadImages(d[1],function(){});var e=f.getUA(1),h=f.getUA(2);if((2>=e||void 0==e)&&(1>h||void 0==h)&&$(".show-warning").html(""),$("#book-img").attr("src",j[0]),q=!1,$("#J_slidebox .left").removeClass("leftin").css("zoom"),$("#J_slidebox .right").removeClass("rightin").css("zoom"),$("#J_slidebox").show(),$("#J_slidebox .left").addClass("leftin").css("zoom"),$("#J_slidebox .right").addClass("rightin").css("zoom"),$("#J_slidebox .left").addAnim("leftin"),m=!0,$("#J_btnsbox").hide(),1==c){$("#J_btnsbox").remove(),$(".footer-weixin").show();var c=g(["minpage/weixin"],function(a){a.getWeixinConfig(u)})}},w=function(a){var b=$("#J_btnsbox");b.removeClass("btns-box-in btns-box-out").css("zoom"),b.addClass("btns-box-in"),setTimeout(function(){b.removeClass("btns-box-in btns-box-out").css("zoom"),b.addClass("btns-box-out")},a)},x=function(a){t.jPlayer({ready:function(a){$(this).jPlayer("setMedia",{mp3:k[n]}).jPlayer("play")},supplied:"mp3",preload:"auto",wmode:"window"}),t.jPlayer("setMedia",{mp3:a}),t.jPlayer("play"),$("#J_btnsbox").show()},y=function(a,b){d.getRequest({url:BEME.APIURL+"/book/bookInfo?id="+a,successfn:function(a){f.loaded(),0===a.code&&v(a.data,b)}})},z=function(){l&&($("#J_loadingbox").hide(),$(".book-page").show(),1!=k[n]&&x(k[n]))},A=function(a){m=!1;var b=$.Deferred();return 0>a&&(a=totalPage+a),$("#J_slidebox .left").removeClass("leftin"),$("#J_slidebox .right").removeClass("rightin"),setTimeout(function(){b.resolve()},0),b.promise()},B=function(){var a=j[n];$("#book-img").attr("src",a),$("#J_slidebox .left").removeClass("leftin").css("zoom"),$("#J_slidebox .right").removeClass("rightin").css("zoom"),$("#J_slidebox").show(),$("#J_slidebox .left").addAnim("leftin"),$("#J_slidebox .right").addAnim("rightin").done(function(){m=!0})},C=function(a){if(!m)return!1;m=!1;var b=n;return n+=a,0>n?n+=o:n%=o,1!=k[n]?x(k[n]):($("#player").jPlayer("stop"),$("#J_btnsbox").hide()),A(b).done(function(){B()}),!1},D=function(c,d){$(window).bind("orientationchange",function(a){1==p?($(".show-warning").show(),0==window.orientation?($(".img-block").addClass("h-block"),$(document.body).css("height",s),$("#J_slidebox").removeClass("hslide-box"),$("#J_btnsbox").removeClass("btns-box-in btns-box-out").css("zoom"),$("#J_btnsbox").addClass("btns-box-in"),$("#J_btnsbox").addClass("btns-h"),$("#book-img").removeClass("imgClass")):($(".show-warning").hide(),$(".img-block").removeClass("h-block"),$(document.body).css("height",r),$("#J_slidebox").addClass("hslide-box"),$("#J_btnsbox").removeClass("btns-h"),$("#book-img").addClass("imgClass"),w(4e3))):($(".show-warning").hide(),$(".img-block").removeClass("h-block"),$("#J_slidebox").removeClass("hslide-box"))}),$("#J_slidebox .sbtn").on("touchstart",function(){var a=1;$(this).hasClass("left")&&(a=-1),C(a)}),$(".img-block").on("click",function(){1==p&&90==window.orientation&&($("#J_btnsbox").hasClass("btns-box-out")?($("#J_btnsbox").removeClass("btns-box-in btns-box-out").css("zoom"),$("#J_btnsbox").addClass("btns-box-in")):w(500))}),$("#J_btnsbox").on("touchstart","#J_btn-replay",function(){$("#player").jPlayer("stop"),$("#player").jPlayer("play")}),$("#J_btn-pushtoy").on("touchstart",function(){var a={},d=i[n];a.url=d.url,a.md5=d.md5,a.type=d.type,a.tag="picture_book",a.tagval=c,a.size=d.filesize;var e=$.extend({},a);e.bid=a.tagval,e.fid=d.id;try{var g=window.bemetoy.getToUerid()}catch(h){g=0}return 1>g?void f.showTips("您尚未绑定玩具!"):(b.playMusic(a,d),_czc.push(["_trackEvent","歌曲推送数","歌曲推送数","歌曲推送数"]),void _czc.push(["_trackEvent","有声绘本","有声绘本",d.name]))}),"onbeforeunload"in window?window.onbeforeunload=function(){$("#player").jPlayer("stop")}:"pagehide"in document&&(document.pagehide=function(){$("#player").jPlayer("stop")}),$(".share_weixin").on("click",function(){var b=window.location.href+"&weixin=1",c={title:u.title,desc:u.desc,url:b,shareType:0,imgUrl:a.imageWeixin(u.imgUrl)};f.shareWeixinUrl(c)}),$(document.body).swipeAsyn(function(a,b){if(b=b.toLowerCase(),"left"==b||"right"==b){var c="left"==b?1:-1;C(c)}a.preventDefault()})};h.init=function(){var a=c.getParams();1==a.weixin?f.setTitle("有声绘本世界"):f.setTitle("有声绘本世界"),y(a.id,a.weixin),D(a.id,a.weixin)},h.uninit=function(){$("#player").remove()}});