/*! 09-05-2016 */
define("minpage/search",["comm/utils","comm/url","comm/request","comm/clickevent","helper/app","helper/temphtml","require","exports"],function(a,b,c,d,e,f,g,h){"use strict";var i="",j={},k=!1,l=!1,m=function(b){var c=$(".search_suggest"),d="";d=a.template("J_temp_hot_list",{list:b.hot}),c.find(".hot_ul").html(d),$("#search_input").focus(),e.backScroll()},n=function(b,d){c.getRequest({url:BEME.APIURL+"/search/searchHot",successfn:function(a){e.loaded(),0===a.code&&m(a.data)}}),c.getRequest({url:BEME.APIURL+"/search/searchUser",type:"post",data:{uid:a.getUid()},successfn:function(b){if(e.loaded(),0===b.code){var c=a.template("J_temp_search_history",{list:b.data.users});$(".history_ul").html(c),$(".search_history").show()}else $(".search_history").hide()}}),d=decodeURI(d),"album"==b&&($("#search_input").val(d),$(".search_header .delete-btn").show(),k=!0,$(".result_header .h_album").click(),$(".header_btn").addClass("enter_btn")),"station"==b&&($("#search_input").val(d),$(".search_header .delete-btn").show(),l=!0,$(".result_header .h_station").click(),$(".header_btn").addClass("enter_btn"))},o=function(b,c){var e=$(".search_result");e.find(".result_header").find(".cur").removeClass("cur"),e.find(".result_header").find(".h_song").addClass("cur");var f="";j={},$.each(b.songs,function(a,b){b._type="album",b.tag="album",j[b.id]=b}),s(b.songs,c),f=a.template("J_temp_song_list",{list:b.songs}),$(".search_result").find("#song-box").html(f),$(".search_suggest").hide(),$(".search_list").hide(),$(".album_list").hide(),$(".station_list").hide(),$(".song_list").show(),$(".no_song").hide(),e.show(),$("#song-box").off("click"),$("#song-box").on("click",".item .item-a",function(){d.pushSong(this)}),$("#song-box").on("click",".item-play",function(){d.audition(j,this)})},p=function(b,c){var d=$(".search_result");d.find(".result_header").find(".cur").removeClass("cur"),d.find(".result_header").find(".h_album").addClass("cur");var e="";s(b.albums,c),e=a.template("J_temp_album_list",{list:b.albums}),$(".search_result").find("#album_list").html(e),$(".search_suggest").hide(),$(".search_list").hide(),$(".album_list").show(),$("#album_list").show(),$(".station_list").hide(),$(".song_list").hide(),$(".no_song").hide(),d.show()},q=function(b,c){var d=$(".search_result");d.find(".result_header").find(".cur").removeClass("cur"),d.find(".result_header").find(".h_station").addClass("cur");var e="";s(b.stations,c),e=a.template("J_temp_station_list",{list:b.stations}),$(".search_result").find("#station_list").html(e),$(".search_suggest").hide(),$(".search_list").hide(),$(".album_list").hide(),$(".station_list").show(),$("#station_list").show(),$(".song_list").hide(),$(".no_song").hide(),d.show()},r=function(){$(".search_result").show(),$(".no_song").show(),$(".search_suggest").hide(),$(".search_list").hide(),$(".search_result").find("#station_list").html(""),$(".search_result").find("#album_list").html(""),$(".search_result").find("#song-box").html(""),c.getRequest({url:BEME.APIURL+"/listen/customRandom",successfn:function(b){if(e.loaded(),0===b.code){var c=a.template("J_temp_song_list",{list:b.data});$("#random_song").html(c),j={},$.each(b.data,function(a,b){b._type="album",b.tag="album",j[b.id]=b}),$("#random_song").off("click"),$("#random_song").on("click",".item .item-a",function(){d.pushSong(this)}),$("#random_song").on("click",".item-play",function(){d.audition(j,this)})}}})},s=function(a,b){""==b||a.length<=0||$.each(a,function(a,c){var d=(c.name,/(.)(?=.*\1)/g),e=c.name;b=b.replace(d,"");for(var f=0;f<b.length;f++)f>=1&&b[f]==b[f-1]||" "!=b[f]&&(e=e.replace(new RegExp(b[f],"g"),"$"+b[f]+"#"),e=e.replace(new RegExp(b[f].toUpperCase(),"g"),"$"+b[f].toUpperCase()+"#"));console.log(e),e=e.replace(new RegExp("\\$","g"),"<span>"),e=e.replace(new RegExp("\\#","g"),"</span>"),console.log(e),c.name=e})},t=function(a){c.getRequest({url:BEME.APIURL+"/search/searchByWord?type=song&name="+a,successfn:function(a){e.loaded();var b=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");0===a.code?(o(a.data,b),$("#song-box").show(),w(b,a.data.songs.length,"song")):($("#song-box").hide(),$("#album_list").hide(),$("#station_list").hide(),$(".song_list").show(),r(),w(b,0,"song"))}})},u=function(a){c.getRequest({url:BEME.APIURL+"/search/searchByWord?type=album&name="+a,successfn:function(a){e.loaded();var b=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");0===a.code?(p(a.data,b),$("#album-box").show(),w(b,a.data.albums.length,"album")):($("#album_list").html(""),$("#album_list").hide(),r(),w(b,0,"album"))}})},v=function(a){c.getRequest({url:BEME.APIURL+"/search/searchByWord?type=station&name="+a,successfn:function(a){e.loaded();var b=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");0===a.code?(q(a.data,b),$("#station-box").show(),w(b,a.data.stations.length,"station")):($("#station_list").html(""),$("#station_list").hide(),r(),w(b,0,"station"))}})},w=function(b,d,f){c.getRequest({url:BEME.APIURL+"/search/addUserInfo",data:{name:b,num:d,uid:a.getUid(),type:f},type:"post",successfn:function(a){e.loaded()}})},x=function(a){c.getRequest({url:BEME.APIURL+"/search/delUserInfo",data:{id:a},successfn:function(a){e.loaded(),0===a.code}})},y=function(b){c.getRequest({url:BEME.APIURL+"/search/searchRecommend",data:{name:b},successfn:function(b){var c="";0===b.code&&(c=a.template("J_temp_search_list",{list:b.data})),$(".search_ul").html(c)}})},z=function(){$(".search_list").hide(),$(".search_suggest").show(),$(".search_header .delete-btn").hide(),$(".search_result").hide(),$(".no_song").hide(),$(".header_btn").removeClass("enter_btn"),n()},A=function(){var a=$(".search_result");a.find(".result_header").find(".cur").removeClass("cur"),a.find(".result_header").find(".h_song").addClass("cur"),a.find(".header_song").find(".current").removeClass("current"),a.find(".header_song").find(".h_all_1").addClass("current"),$(".search_header .delete-btn").show()},B=function(){$("#search_input").on("input propertychange",function(){var a=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");a!=i&&""!=a&&(i=a,y(a)),""==a?z():($(".search_list").show(),$(".search_suggest").hide(),$(".search_header .delete-btn").show(),$(".search_result").hide(),$(".header_btn").addClass("enter_btn"))}),$("#search_input").on("keypress",function(a){"13"==a.keyCode&&$(".header_btn").click()}),$(".header_btn").on("click",function(){var a=$(this);a.hasClass("enter_btn")&&($(".result_header .h_song").click(),$(".header_song .h_all_1").click())}),$(".history_ul").on("click",".search_name",function(){var a=$(this).text();t(a),$("#search_input").val(a),A()}),$(".history_ul").on("click",".delete",function(){var a=$(this).attr("_id"),b={};b.content="确定删除所选历史？",e.showAlert(b,function(){x(a),n()})}),$(".clear_list").on("click","a",function(){var a={};a.content="确定删除所有历史？",e.showAlert(a,function(){x(0),n()})}),$(".result_header").on("click","li",function(){var a=$(this);a.parent().find(".cur").removeClass("cur"),a.addClass("cur");var b=a.attr("_type"),c=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");return"song"==b?($(".song_list").show(),$(".album_list").hide(),$(".station_list").hide(),void t(c)):"album"==b?($(".song_list").hide(),$(".album_list").show(),$(".station_list").hide(),void(k?u(c):window.location.href="?m=search&type=album&name="+c)):"station"==b?($(".song_list").hide(),$(".album_list").hide(),$(".station_list").show(),void(l?v(c):window.location.href="?m=search&type=station&name="+c)):void 0}),$("#header_song").on("click","li",function(){var a=$(this);a.parent().find(".current").removeClass("current"),a.addClass("current");var b=a.attr("_id"),c=$("#search_input").val().replace(/(^\s*)|(\s*$)/g,"");""!=b&&(c+="@tags_name"+b),t(c)}),$(".search_ul").on("click","li",function(){var a=$(this);$("#search_input").val(a.text()),$(".header_btn").click(),A()}),$(".hot_ul").on("click","a",function(){var a=$(this);t(a.text()),$("#search_input").val(a.text()),A()}),$(".delete-btn").on("click",function(){$("#search_input").val(""),i="",z()})};h.init=function(){var c=b.getParams();a.headerMenu(),e.showHeader(),e.setTitle("搜索"),B(),n(c.type,c.name)},h.uninit=function(){}});