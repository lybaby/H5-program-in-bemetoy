/*! 09-05-2016 */
define("comm/pushsong",["comm/url","helper/app","comm/request","require","exports"],function(a,b,c,d,e){"use strict";var f=!1,g=function(a,d,e){if(1==b.getUA(0)?b.showOneTips("推送成功!"):b.showTips("推送成功!"),c.getRequest({url:BEME.APIURL+"/albums/playSong",data:{tag:e,tag_id:a,song_id:d},type:"POST",successfn:function(a){}}),$("#num")){var f=$("#num").text();f=+f+1,$("#num").html(f)}},h=function(a,d){if(b.showTips("推送成功!"),$("#J_random-box").hide(),b.hideMask(),d?$("#J_body-mask").show():c.getRequest({url:BEME.APIURL+"/listen/getUnPlay",type:"POST",successfn:function(a){if(0==a.code&&a.data>30){var c="玩具已有"+a.data+"首歌曲尚未播放，快去播给宝宝听吧~";b.showAlert(c)}}}),$.each(a,function(a,b){c.getRequest({url:BEME.APIURL+"/albums/playSong",data:{tag:b.tag,tag_id:b.bid,song_id:b.fid},type:"POST",successfn:function(a){}})}),$("#num")){var e=$("#num").text();e=+e+a.length,$("#num").html(e)}};e.getUid=function(){var a,b;try{a=window.bemetoy.getFromUerid(),b=window.bemetoy.getToUerid()}catch(c){a=0,b=0}return{from:a,to:b}},e.getPushUrl=function(){var a="short.bemetoy.com/push_music",b=location.host.split(".");return b.length>3&&(a=b[0]+"."+a),"http://"+a};var i={};i.stringify=function(a){if(a instanceof Object){var b="";if(a.constructor===Array){for(var c=0;c<a.length;b+=i.stringify(a[c])+",",c++);return"["+b.substr(0,b.length-1)+"]"}if(a.toString!==Object.prototype.toString)return'"'+a.toString().replace(/"/g,"\\$&")+'"';for(var d in a)b+='"'+d.replace(/"/g,"\\$&")+'":'+i.stringify(a[d])+",";return"{"+b.substr(0,b.length-1)+"}"}return"string"==typeof a?'"'+a.replace(/"/g,"\\$&")+'"':String(a)},e.stringify=i.stringify,e.playMusic=function(a,c){if(!f){f=!0;var d=e.getUid(),h=e.stringify(a);if(d.to<1)return void(b.getUA(0)>1?window.location.href="#!m=pushfail&text=1&type="+a.tag:b.showOneTips("您尚未绑定玩具!"));a={fromuid:d.from,touid:d.to,pushBuf:h},$.ajax({url:e.getPushUrl(),dataType:"jsonp",type:"get",jsonp:"cb",cache:!1,data:a,error:function(a,b,c){f=!1},success:function(a){1001===a.result&&b.showAlert(a.res_info),e.musicAddScore(),g(c.bid,c.fid,c.tag),f=!1}})}},e.musicAddScore=function(){try{var a=b.getUA(1),c=b.getUA(0);a>0&&c>1&&window.bemetoy.musicAddScore()}catch(d){}},window.onMusicAddScoreResult=function(a){var b=parseInt(a);if(b>0){$("#J_score-tips .point").text("+"+b);var c=$("#J_score-tips");$("#J_score-tips").show(),c.addClass("tipsscore"),setTimeout(function(){c.removeClass("tipsscore"),$("#J_score-tips").hide()},3e3)}else $("#J_score-tips").hide()},e.playAllMusic=function(a,c){if(!f){f=!0;var d=e.getUid(),g=e.stringify(a);if(d.to<1)return $("#J_random-box").hide(),b.hideMask(),void(window.location.href="#!m=pushfail&text=1&type="+a[0].tag);a={fromuid:d.from,touid:d.to,pushBuf:g},$.ajax({url:e.getPushUrl(),dataType:"jsonp",type:"get",jsonp:"cb",cache:!1,data:a,success:function(a){var d=!1;1001===a.result&&(d=!0,b.showAlert(a.res_info)),e.musicAddScore(),$(".item-a").filter(".play-btn").attr("value",0),h(c,d),f=!1}})}}});